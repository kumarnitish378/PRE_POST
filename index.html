<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js">
    </script>
    <title>Ecg Simulator</title>
</head>

<body>
    <h1>Hello World</h1>
    <div class="graph">
        <canvas id="myChart" style="width:100%;max-width:700px"></canvas>
    </div>
    <div class="parameters">
        <div class="interval">
            P Interval(ms)  :<input type="number" id="p_dur" value=50><br><br>
            PQ Interval(ms) :<input type="number" id="pq_dur" value=50><br><br>
            QRS Interval(ms) :<input type="number" id="qrs_dur" value=120><br><br>
            ST Interval(ms)  :<input type="number" id="st_dur" value=50><br><br>
            T Interval(ms)   :<input type="number" id="t_dur" value=50><br><br>
        </div>
        <div class="amplitude">
            P Amplitude(mv)  :<input type="number" id="p_amp" value=0.9><br><br>
            Q Amplitude(mv)  :<input type="number" id="q_amp" value=-1><br><br>
            R Amplitude(mv)  :<input type="number" id="r_amp" value=6><br><br>
            S Amplitude(mv)  :<input type="number" id="s_amp" value=-3.2><br><br>
            ST Amplitude(mv)  :<input type="number" id="st_amp" value=0><br><br>
            T Amplitude(mv)  :<input type="number" id="t_amp" value=1.2><br><br>
        </div>
        <button type="button" onclick="myFunction()" style="color: rgb(255, 0, 0);">Update graph</button>
    </div>
    <style>
        .parameters {
            display: flex;
            margin-left: 10px;
        }
    </style>
    <script>

        function linspace(startValue, stopValue, cardinality) {
            var arr = [];
            var step = (stopValue - startValue) / (cardinality - 1);
            for (var i = 0; i < cardinality; i++) {
                arr.push(startValue + (step * i));
            }
            return arr;
        }

        function sin_wave(sample_len, freq, amp) {
            const pi = freq * 2 * (22 / 7);
            var step_size = pi / sample_len;
            var a_wave = [];
            var i = 0;
            var ind = 0;
            while (i <= pi) {
                a_wave.push(amp * Math.sin(i));
                i = i + step_size;
            }
            return a_wave;
        }

        const convolve = (vec1, vec2) => {
            if (vec1.length === 0 || vec2.length === 0) {
                throw new Error("Vectors can not be empty!");
            }
            const volume = vec1;
            const kernel = vec2;
            let displacement = 0;
            const convVec = [];

            for (let i = 0; i < volume.length; i++) {
                for (let j = 0; j < kernel.length; j++) {
                    if (displacement + j !== convVec.length) {
                        convVec[displacement + j] =
                            convVec[displacement + j] + volume[i] * kernel[j];
                    } else {
                        convVec.push(volume[i] * kernel[j]);
                    }
                }
                displacement++;
            }
            return convVec;
        };


        // ==============================

        // signal length
        var s_len = 0
        // First Iso elextric Line
        var dur1, per_sample, sample_rate, desire_interval;
        sample_rate = 500;
        per_sample = 1000 / sample_rate;
        var total_duration = 2000;
        var total_sample = Number.parseInt(total_duration / per_sample);
        console.log(total_sample);

        // ====================================================
        var desire_interval, desire_p_duration, desire_pq_duration, q_int, rs_dur, ru_dur, s_dur, st_dur, t_dur;
        // Intervals in ms
        // Iso Electric
        desire_interval = 50;
        // Pr interval
        desire_p_duration = 100;
        desire_pq_duration = 80;
        // QRS Duration
        var qrs_int = 60;
        var sp_int = qrs_int / 6;
        q_int = sp_int;
        ru_dur = sp_int * 2;
        rs_dur = sp_int * 2;
        s_dur = sp_int;
        // ST Interval
        st_dur = 50;
        // T Interval
        t_dur = 100;


        var sum = desire_interval + desire_p_duration + desire_pq_duration + q_int + rs_dur + ru_dur + s_dur + st_dur + t_dur;
        console.log(sum);
        console.log("<br>");
        console.log(total_sample);
        console.log("<br>");
        if (sum > total_sample) {
            alert("Invailed Parameters")
        }

        var margin = Number.parseInt((total_sample - sum) / 2);
        desire_interval = margin;
        console.log("<br>");
        console.log(margin);

        // Amplitude of Components in mv
        var p_amp = 0.9;
        var q_amp = -1;
        var r_amp = 6;
        var s_amp = -3.2;
        var st_amp = 0;
        var t_amp = 1.2;
        // ====================================================

        // Isoelectric time interval
        // var desire_interval = 95;
        dur1 = Number.parseInt(desire_interval / per_sample);

        s_len = s_len + dur1;  // Updating signal length
        var iso_line1 = linspace(0, 0, dur1);

        // PR interval
        // 1. Creating P wave using Sin Wave
        const freq = 0.5;
        // var desire_p_duration = 50; // ms;
        // var p_amp = 0.9;
        var p_dur = Number.parseInt(desire_p_duration / per_sample);
        s_len = s_len + p_dur;  // Updating signal length

        var x = linspace(0, p_dur, p_dur);
        // var yValues = sin_wave(p_dur, 0.5, p_amp);
        var p_wave = sin_wave(p_dur, 0.5, p_amp);

        // 2. second isoelectric
        // var desire_pq_duration = 30;
        var dur = Number.parseInt(desire_pq_duration / per_sample);
        s_len = s_len + dur;  // Updating signal length
        var iso_line2 = linspace(0, 0, dur);
        console.log(iso_line2);

        // # QRS Segments
        // # Note: QRS interval = q + ru + rd + s
        // # Example:
        // #   QRS =  40 + 40 + 40 + 40  = 120 ms

        // 1. PQ Segments
        // var q_int = 20;
        // var q_amp = -1;
        var dur1 = Number.parseInt(q_int / per_sample);
        s_len = s_len + dur1;  // Updating signal length
        var pq_seg = linspace(0, q_amp, dur1);
        console.log(pq_seg)

        // 2. QR segments
        // var ru_dur = 20;
        // var r_amp = 6;
        var dur1 = Number.parseInt(ru_dur / per_sample);
        s_len = s_len + dur1;  // Updating signal length
        var ru = linspace(q_amp, r_amp, dur1);

        // RS Segments
        // var rs_dur = 20;
        var rd = Number.parseInt(rs_dur / per_sample);
        s_len = s_len + rd;  // Updating signal length
        // var s_amp = -3.2;
        var rs = linspace(r_amp, s_amp, rd);

        // S duration
        // var s_dur = 20;
        // var st_amp = 0;
        var dur1 = Number.parseInt(s_dur / per_sample);
        s_len = s_len + dur1;  // Updating signal length
        var sj = linspace(s_amp, st_amp, dur1);

        // ========= End QRS ============


        // ST Segements
        // var st_dur = 50;
        var dur1 = Number.parseInt(st_dur / per_sample);
        s_len = s_len + dur1;  // Updating signal length
        var st_seg = linspace(st_amp, st_amp, dur1);

        // T Wave
        // var t_dur = 50;
        // var t_amp = 3.2;
        var dur1 = Number.parseInt(t_dur / per_sample);
        s_len = s_len + dur1;  // Updating signal length
        var t_wave = sin_wave(dur1, 0.5, t_amp);
        console.log(t_wave);
        console.log(s_len);

        var ecg_signal = iso_line1.concat(p_wave, iso_line2, pq_seg, ru, rs, sj, st_seg, t_wave, iso_line1);
        console.log(ecg_signal);

        yValues = ecg_signal;

        // Convolution Section
        var vec1 = [2, 3, 4]
        var vec2 = sin_wave(5, 0.5, 1);

        var data = convolve(yValues, vec2);
        console.log(data.length);
        yValues = data;

        var x = linspace(0, 1, data.length);
        var myChart = new Chart("myChart",
            {
                type: "line",
                data: {
                    labels: x,
                    datasets: [
                        {
                            backgroundColor: "rgba(100,10,0,1.0)",
                            // borderColor: "rgba(10,0,0,0.1)",
                            borderColor: 'rgb(75, 192, 192)',
                            label: 'ECG One Sample',
                            fill: true,
                            tension: 0.1,
                            data: yValues,
                            pointRadius: 0
                        }]
                },
                options: {}
            });

    </script>
</body>

</html>